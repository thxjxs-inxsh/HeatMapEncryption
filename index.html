<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture & Encrypt (Thermal)</title>
    <style>
        canvas {
            border:1px solid #000;
            margin: 5px;
        }
        body{
            background-color: black;
            color: aliceblue;
            align-items: center;
            text-align: center;
        }
        button{
            width:200px;
            height:50px;
        }
        button:hover{
            background-color: whitesmoke;
        }
    </style>
</head>
<body>
    <h1>HeatMap Encryption</h1>
    <h2>Front Camera Capture & Encrypt</h2>
    <h4>More shaking, the better!</h4>
    <video id="camera" width="400" height="300" autoplay playsinline></video>
    <br><br>
    <button id="captureBtn">Capture 5 Photos</button>
    <br><br>
    <div id="thermalContainer"></div>
     <button id="encryptBtn">Encrypt</button> <br><br>
<div id="keyContainer">Generated key: <span id="generatedKey"></span></div>
<!-- Input for message -->
<label for="messageInput">Enter message to encrypt:</label>
<input type="text" id="messageInput" size="50">
<button id="encryptMsgBtn">Encrypt Message</button>
<div id="encryptedMessageContainer">
    Encrypted message: <span id="encryptedMessage"></span>
</div>
<hr>
<div>
    <centre>
        <p>Made By</p>
        <h4>Thejas Inesh M</h4>
    </centre>
</div>
    <script>
        const video = document.getElementById("camera");
        const captureBtn = document.getElementById("captureBtn");
        const encryptBtn = document.getElementById("encryptBtn");
        const thermalContainer = document.getElementById("thermalContainer");
        const keyDisplay = document.getElementById("keyDisplay");
        async function openFrontCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" }
                });
                video.srcObject = stream;
            } catch (err) {
                alert("Error accessing camera: " + err.message);
                console.error(err);
            }
        }
        openFrontCamera();
        function thermalColor(value) {
            const r = Math.min(255, value * 2);
            const g = Math.max(0, 255 - Math.abs(value - 128) * 2);
            const b = Math.max(0, 255 - value * 2);
            return [r, g, b];
        }
        captureBtn.addEventListener("click", async () => {
            thermalContainer.innerHTML = "";
            for (let n = 0; n < 5; n++) {
                const canvas = document.createElement("canvas");
                canvas.width = 400;
                canvas.height = 300;
                const context = canvas.getContext("2d");
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const frame = context.getImageData(0, 0, canvas.width, canvas.height);
                const data = frame.data;
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    const [r, g, b] = thermalColor(avg);
                    data[i] = r;
                    data[i + 1] = g;
                    data[i + 2] = b;
                }
                context.putImageData(frame, 0, 0);

                thermalContainer.appendChild(canvas);
                await new Promise(res => setTimeout(res, 200));
            }
        });
encryptBtn.addEventListener("click", async () => {
    const canvases = thermalContainer.getElementsByTagName("canvas");
    const imagesData = Array.from(canvases).map(c => c.toDataURL("image/png"));

    try {
        const response = await fetch("/encrypt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ images: imagesData })
        });

        const result = await response.json();
        const keySpan = document.getElementById("generatedKey");
        keySpan.textContent = result.key || "Error generating key";

    } catch (err) {
        console.error(err);
        const keySpan = document.getElementById("generatedKey");
        keySpan.textContent = "Error sending images to backend";
    }
});
const encryptMsgBtn = document.getElementById("encryptMsgBtn");
const messageInput = document.getElementById("messageInput");
const encryptedMessageSpan = document.getElementById("encryptedMessage");

encryptMsgBtn.addEventListener("click", async () => {
    const message = messageInput.value;
    const key = document.getElementById("generatedKey").textContent;

    if (!message) {
        alert("Please enter a message to encrypt!");
        return;
    }
    if (!key) {
        alert("Please generate the key first by capturing images!");
        return;
    }
    try {
        const response = await fetch("/encrypt_message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: message, key: key })
        });

        const result = await response.json();
        encryptedMessageSpan.textContent = result.encrypted_message || "Error";
    } catch (err) {
        console.error(err);
        encryptedMessageSpan.textContent = "Error sending message to backend";
    }
});
    </script>
</body>
</html>

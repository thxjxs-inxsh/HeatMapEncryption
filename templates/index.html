<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HeatMap Encryption</title>
<style>
    body {
        background-color: black;
        color: aliceblue;
        text-align: center;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
    }

    h1, h2, h4 {
        margin: 10px 0;
    }

    /* Video styling */
    video {
        width: 100%;
        max-width: 700px;
        height: auto;
        border: 2px solid white;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    /* Container for buttons */
    .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin: 15px 0;
    }

    button, input[type="text"] {
        flex: 1 1 200px; /* grow/shrink, min width 200px */
        max-width: 300px;
        height: 45px;
        font-size: 16px;
        border-radius: 5px;
        border: none;
    }

    button:hover {
        background-color: whitesmoke;
        cursor: pointer;
        color: black;
    }

    input[type="text"] {
        padding: 5px 10px;
        font-size: 16px;
    }

    /* Captured images container */
    #thermalContainer {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        justify-items: center;
        margin: 15px 0;
    }

    canvas {
        width: 100%;
        height: auto;
        border: 1px solid #fff;
        border-radius: 5px;
    }

    #keyContainer, #encryptedMessageContainer {
        margin: 10px 0;
        word-break: break-word;
    }

    hr {
        margin: 20px 0;
        border: 0.5px solid #555;
    }

    footer {
        margin: 20px 0;
        font-size: 14px;
    }

</style>
</head>
<body>
    <h1>HeatMap Encryption</h1>
    <h2>Front Camera Capture & Encrypt</h2>
    <h4>More shaking, the better!</h4>

    <!-- Video & buttons -->
    <video id="camera" autoplay playsinline></video>
    <div class="controls">
        <button id="captureBtn">Capture 5 Photos</button>
        <button id="encryptBtn">Encrypt</button>
    </div>

    <!-- Captured canvases -->
    <div id="thermalContainer"></div>

    <!-- Key display -->
    <div id="keyContainer">Generated key: <span id="generatedKey"></span></div>

    <!-- Message encryption -->
    <div class="controls">
        <input type="text" id="messageInput" placeholder="Enter message to encrypt">
        <button id="encryptMsgBtn">Encrypt Message</button>
    </div>
    <div id="encryptedMessageContainer">Encrypted message: <span id="encryptedMessage"></span></div>

    <hr>

    <footer>
        <p>Made By</p>
        <h4>Thejas Inesh M</h4>
    </footer>

<script>
const video = document.getElementById("camera");
const captureBtn = document.getElementById("captureBtn");
const encryptBtn = document.getElementById("encryptBtn");
const thermalContainer = document.getElementById("thermalContainer");

async function openFrontCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        video.srcObject = stream;
    } catch (err) {
        alert("Error accessing camera: " + err.message);
        console.error(err);
    }
}
openFrontCamera();

function thermalColor(value) {
    const r = Math.min(255, value * 2);
    const g = Math.max(0, 255 - Math.abs(value - 128) * 2);
    const b = Math.max(0, 255 - value * 2);
    return [r, g, b];
}

// Capture 5 photos
captureBtn.addEventListener("click", async () => {
    thermalContainer.innerHTML = "";
    for (let n = 0; n < 5; n++) {
        const canvas = document.createElement("canvas");
        canvas.width = 400;
        canvas.height = 300;
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);

        const frame = context.getImageData(0, 0, canvas.width, canvas.height);
        const data = frame.data;
        for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i+1] + data[i+2]) / 3;
            const [r,g,b] = thermalColor(avg);
            data[i] = r;
            data[i+1] = g;
            data[i+2] = b;
        }
        context.putImageData(frame, 0, 0);
        thermalContainer.appendChild(canvas);
        await new Promise(res => setTimeout(res, 200));
    }
});

// Encrypt images and generate key
encryptBtn.addEventListener("click", async () => {
    const canvases = thermalContainer.getElementsByTagName("canvas");
    const imagesData = Array.from(canvases).map(c => c.toDataURL("image/png"));

    try {
        const response = await fetch("/encrypt", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ images: imagesData })
        });
        const result = await response.json();
        document.getElementById("generatedKey").textContent = result.key || "Error generating key";
    } catch (err) {
        console.error(err);
        document.getElementById("generatedKey").textContent = "Error sending images to backend";
    }
});

// Encrypt message
const encryptMsgBtn = document.getElementById("encryptMsgBtn");
encryptMsgBtn.addEventListener("click", async () => {
    const message = document.getElementById("messageInput").value;
    const key = document.getElementById("generatedKey").textContent;
    if (!message) { alert("Enter message!"); return; }
    if (!key) { alert("Generate key first!"); return; }

    try {
        const response = await fetch("/encrypt_message", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message, key })
        });
        const result = await response.json();
        document.getElementById("encryptedMessage").textContent = result.encrypted_message || "Error";
    } catch (err) {
        console.error(err);
        document.getElementById("encryptedMessage").textContent = "Error sending message to backend";
    }
});
</script>
</body>
</html>
